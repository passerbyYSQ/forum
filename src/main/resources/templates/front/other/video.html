<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>视频播放</title>
    <link rel="stylesheet" th:href="@{/admin/assets/libs/layui/css/layui.css}" href="../res/layui/css/layui.css">
    <link rel="stylesheet" th:href="@{/front/res/css/global.css}" href="../res/css/global.css">
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: auto;
            overflow: hidden;
            margin-top: 0;
        }

        body {
            /*display: flex;*/
        }

        /*#videoContainer {*/
        /*    flex: auto;*/
        /*}*/

        .xgplayer-skin-default .xgplayer-panel-slider {
            left: -200px !important;
        }

        .danmu-input-container {
            width: 100%;
            height: 100%;
            padding: 8px 4px !important;
            box-sizing: border-box;
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
        }

        .danmu-input {
            width: 70%;
            height: 100%;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.75);
            color: #333;
            padding: 0 8px !important;
            caret-color: #F85959;
        }

        .btn-send {
            background: transparent;
            color: rgba(255, 255, 255, 0.75);
            cursor: pointer;
            width: 15%;
            max-width: 28px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-left: 8px !important;
        }
    </style>
</head>
<body style="margin: 0;">
<div style="height:61px;">
    <iframe scrolling="no" id="main" name="main" frameborder="0" th:src="@{/head}"
            style="width:100%;height:100%;"></iframe>
</div>
<!-- 正文开始 -->
<div id="videoContainer"></div>

<!-- js部分 -->
<script th:src="@{/admin/assets/libs/layui/layui.js}" src="../res/layui/layui.js"></script>
<script th:src="@{/admin/assets/js/common.js(v=318)}" src="admin/js/common.js?v=318"></script>
<script>
    layui.use(['Player', 'app', 'ClientWebSocket'], function () {
        var $ = layui.jquery;
        // var Player = layui.Player;
        // var ClientWebSocket = layui.ClientWebSocket;
        var app = layui.app;
        var playerObj;
        var socket;

        window.addEventListener('resize', function () {
            var videoContainer = document.getElementById('videoContainer');
            videoContainer.style.height = (window.innerHeight - 61) + 'px';
            videoContainer.style.width = window.innerWidth + 'px';
        });

        app.ajax('/danmu/1', {}, function (res) {
            app.successNotice(`${res.data.length}条弹幕装载成功...`);
            initPlayer(res.data);
            initSocket();
        }, "get");

        function initSocket() {
            if (!app.getCookie('token')) {
                return;
            }
            socket = new layui.ClientWebSocket({
                channelType: 'DANMU',
                extra: 1
            })
        }

        function sendMsg(data) {
            if (socket) {
                socket.send(new app.Msg(app.MSG_TYPE.DANMU, data));
            }
        }

        function initPlayer(danmuList) {
            // 开启弹幕
            var danmuCommonStyle = {
                color: true,
                style: {
                    color: '#ffcd08',
                    fontSize: '20px'
                },
                duration: 15000
            };
            var meDanmuStyle = {  //弹幕自定义样式
                color: '#f85959',
                fontSize: '20px',
                border: 'solid 2px #f85959',
                borderRadius: '50px',
                padding: '2px 10px'
            };
            var commentList = danmuList.map(danmu => {
                var comment = {
                    id: danmu.id,
                    start: danmu.startMs,
                    txt: danmu.content,
                };
                Object.assign(comment, danmuCommonStyle);
                return comment;
            });
            playerObj = new layui.Player({
                id: 'videoContainer',
                url: '//sf1-cdn-tos.huoshanstatic.com/obj/media-fe/xgplayer_doc_video/mp4/xgplayer-demo-720p.mp4',
                autoplay: false,
                height: window.innerHeight - 61,
                width: window.innerWidth,
                lang: 'zh-cn',
                danmu: {
                    panel: true,
                    comments: commentList
                }
            });

            var controlsPlaceholder = playerObj.controls.getElementsByClassName('xgplayer-placeholder');
            controlsPlaceholder[0].appendChild(createSendDanmuDom());

            function createSendDanmuDom() {
                // container
                var div = document.createElement('div');
                div.className = 'danmu-input-container';
                // input
                var input = document.createElement('input');
                input.className = 'danmu-input';
                input.placeholder = '发送弹幕跟大家一起评论吧';
                var sendFn = function () {
                    var txt = input.value.trim();
                    if (!txt) {
                        return;
                    }
                    var danmu = {
                        id: new Date().getTime() + '_' + Math.random(),
                        start: playerObj.currentTime * 1000,
                        txt
                    };
                    Object.assign(danmu, danmuCommonStyle);
                    danmu.style = meDanmuStyle;
                    playerObj.danmu.sendComment(danmu);
                    // TODO 推送
                    sendMsg({
                        content: txt,
                        startMs: danmu.start,
                        videoId: 1
                    });
                    console.log('发送成功', danmu);
                    input.value = '';
                };
                input.addEventListener('keydown', function (ev) {
                    if (ev.keyCode !== 13) {
                        return;
                    }
                    sendFn();
                });
                div.appendChild(input);
                // button
                var btn = document.createElement('button');
                btn.className = 'btn-send';
                btn.innerText = '发送';
                btn.addEventListener('click', sendFn);
                div.appendChild(btn);
                return div;
            }
        }

    });
</script>
</body>
</html>
